{
  "comments": [
    {
      "key": {
        "uuid": "a3b9a1e8_a6a4dc8b",
        "filename": "test/bdev/blockdev.sh",
        "patchSetId": 4
      },
      "lineNbr": 266,
      "author": {
        "id": 1011256
      },
      "writtenOn": "2019-12-12T11:48:21Z",
      "side": 1,
      "message": "Suggestion for separate patch: any reason why we run this in nightly?\nIt\u0027s just 2 seconds :)",
      "range": {
        "startLine": 266,
        "startChar": 0,
        "endLine": 266,
        "endChar": 31
      },
      "revId": "8f98afd6fdca56f6ec8ce3ec6a5e55aa9a5241b0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "38915c2a_8e3a2233",
        "filename": "test/bdev/blockdev.sh",
        "patchSetId": 4
      },
      "lineNbr": 266,
      "author": {
        "id": 1011223
      },
      "writtenOn": "2019-12-12T17:10:32Z",
      "side": 1,
      "message": "Agreed. Not sure why this is nightly in the first place.",
      "parentUuid": "a3b9a1e8_a6a4dc8b",
      "range": {
        "startLine": 266,
        "startChar": 0,
        "endLine": 266,
        "endChar": 31
      },
      "revId": "8f98afd6fdca56f6ec8ce3ec6a5e55aa9a5241b0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c77dd5c9_d09e9176",
        "filename": "test/bdev/blockdev.sh",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1011256
      },
      "writtenOn": "2019-12-12T11:48:21Z",
      "side": 1,
      "message": "Can we move this block a couple lines up, just before we create GPT partitions, and just run the test aginst plain NVMe BDEV?\n\nI think it would be the simplest solution, removing the need for \"if\" blocks here and on line 287.\nIntroducing these \u0027ifs\u0027 makes the test completion report variable. There\u0027s a possibility you\u0027d get hello_bdev run vs. GPT and the other time you could get it run vs plain NVMe.\n\nFor line 287 on the other hand you\u0027d either get a test completion, or no completion at all, depending on the system in test.",
      "range": {
        "startLine": 267,
        "startChar": 0,
        "endLine": 274,
        "endChar": 3
      },
      "revId": "8f98afd6fdca56f6ec8ce3ec6a5e55aa9a5241b0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2a387b51_0df622d5",
        "filename": "test/bdev/blockdev.sh",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1011223
      },
      "writtenOn": "2019-12-12T17:10:32Z",
      "side": 1,
      "message": "I\u0027d prefer to keep a separation between the test cases and the pre-work.\n\nIn terms of running the hello_world application vs gpt or a standard NVMe, I\u0027m totally fine with reporting the same test completion for both of those cases. In my mind the purpose of the hello_bdev test is to just make sure that test application didn\u0027t break because of change. It\u0027s not trying to verify the functionality of any specific bdev.\n\nAnd I think we should only run the tests on 287-288 if we are using gpt. The titles of the tests are bdev_gpt_verify and bdev_gpt_write_zeroes. If we don\u0027t have gpt on a specific machine, that machine shouldn\u0027t report a completion for that test.",
      "parentUuid": "c77dd5c9_d09e9176",
      "range": {
        "startLine": 267,
        "startChar": 0,
        "endLine": 274,
        "endChar": 3
      },
      "revId": "8f98afd6fdca56f6ec8ce3ec6a5e55aa9a5241b0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "19e53746_897fef1b",
        "filename": "test/bdev/blockdev.sh",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1011256
      },
      "writtenOn": "2019-12-13T07:11:09Z",
      "side": 1,
      "message": "\u003e I\u0027d prefer to keep a separation between the test cases and the pre-work.\n\nI was suspecting that:)\n\n\u003e If we don\u0027t have gpt on a specific machine, that machine shouldn\u0027t report a completion for that test.\n\nHow about we make sgdisk a hard dependency, install it on all CI systems? That way we could just exit with error if GPT partition was not created and avoid doing \"ifs\"",
      "parentUuid": "2a387b51_0df622d5",
      "range": {
        "startLine": 267,
        "startChar": 0,
        "endLine": 274,
        "endChar": 3
      },
      "revId": "8f98afd6fdca56f6ec8ce3ec6a5e55aa9a5241b0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9b029e99_20345cb7",
        "filename": "test/bdev/blockdev.sh",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1011221
      },
      "writtenOn": "2019-12-13T09:34:26Z",
      "side": 1,
      "message": "I\u0027d tend to agree with Karol that we do not want to be uncertain which tests are ran on which system.\n\nFor example looking at the tests right now. lines 288-289 on *current master* execute on FreeBSD. But since part_dev_by_gpt didn\u0027t partition drives there, bdev_gpt.conf only consisted of not partitioned nvme device. This does not seem like an obvious course just by reading this script.\n\nGoals would be have scripts execute expected tests and fail if its not possible. Avoiding situations where tests change their meaning or are skipped in unexpected moments. This can lead to decreasing test coverage, without anyone even knowing.\nIf someone was to uninstall sgdisk from all systems, we wouldn\u0027t notice it in test results. All due to line 245 and 302 masking errors from part_dev_by_gpt.\n\nThe challenge you are undertaking with this patch series is the right direction and to assure we don\u0027t compromise those efforts I\u0027d suggest some modifications.\n\n1) Currently all tests are ran against GPT on systems where part_dev_by_gpt succeed. bdev.conf contains the partitioned nvme too, due to line 250. Even fio tests ran against gpt disks. Lets make it clear by having just single bdev.conf.\n2) part_dev_by_gpt should be changed so it works on any system SPDK supports. If it does not, fail blockdev.sh just like with missing fio. This would require to add sgdisk to some systems (ubuntu?) in vm_setup.sh and work out FreeBSD.\n\nAbove does not have to be part of this patch. If this one was supposed to address failure on nightly tests, let\u0027s just solve the hello_bdev part. Either moving it up before partitioning or taking the bdev it is run against from \u0027bdevs_name\u0027 variable.",
      "parentUuid": "19e53746_897fef1b",
      "range": {
        "startLine": 267,
        "startChar": 0,
        "endLine": 274,
        "endChar": 3
      },
      "revId": "8f98afd6fdca56f6ec8ce3ec6a5e55aa9a5241b0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1398463e_e9448722",
        "filename": "test/bdev/blockdev.sh",
        "patchSetId": 4
      },
      "lineNbr": 274,
      "author": {
        "id": 1011223
      },
      "writtenOn": "2019-12-13T17:21:40Z",
      "side": 1,
      "message": "\u003e I\u0027d tend to agree with Karol that we do not want to be uncertain which tests are ran on which system.\n\nI also agree with this, but I would like to propose a different methodology.\n\n\u003e Goals would be have scripts execute expected tests and fail if its not possible. Avoiding  situations where tests change their meaning or are skipped in unexpected moments. This can \nlead to decreasing test coverage, without anyone even knowing.\n\nI think that there will always be conditionals in the tests. Whether it\u0027s due to a kernel version, a certain package not being installed, or the fact that we are on FreeBSD. Rather than trying to go through all of the test scripts and eliminate every single if statement in them, we should add a step in the post processing script when we read through all of the completed tests. If any test (that doesn\u0027t contain nightly in its name) is not run on an autotest_per_patch job, then we fail that run. Then there is no guessing about whether all of the tests were executed.\nEven if we do get rid of all of the ifs related to system capabilities, there are still nested ifs around test flags that result in the same problem. I just think trying to remove conditionals is a band-aid solution. Standardizing around the test case framework and adding a step to autorun_post.sh gives a sweeping solution that we can be much more confident in.\n\nFor example, even after we settle on what we are doing about GPT, we still have three conditionals in the blockdev tests that determine which bdevs are being used in the tests and significantly affect coverage - \"if [ $SPDK_TEST_RBD -eq 1 ]; then\", \"if [ $SPDK_TEST_CRYPTO -eq 1 ]; then\", \"if hash pmempool; then\". I think all three of these play just as large of a role in affecting coverage.\n\n\u003e 1) Currently all tests are ran against GPT on systems where part_dev_by_gpt succeed. bdev.conf contains the partitioned nvme too, due to line 250. Even fio tests ran against gpt disks. Lets make it clear by having just single bdev.conf.\n2) part_dev_by_gpt should be changed so it works on any system SPDK supports. If it does not, fail blockdev.sh just like with missing fio. This would require to add sgdisk to some systems (ubuntu?) in vm_setup.sh and work out FreeBSD.\n\nI agree with both of these, but like you said, it\u0027s best to address then in another patch. Also, I want to address the other issues silently affecting test coverage in the bdev tests. But I\u0027m trying to do one(ish) thing at a time and was going to save the whole blockdev refactor until after this patch series went through.\n\n\u003e If this one was supposed to address failure on nightly tests, let\u0027s just solve the hello_bdev part.\n\nYes, that is the only purpose of this patch., which I feel like my patch currently accomplishes. But in the interest of progress, I will just switch hello_bdev to 1. run all the time so we know it\u0027s fixed. and 2. run against a malloc bdev because all this test is trying to accomplish is running the application to make sure it didn\u0027t break.\nIn patches on a different thread, we can address the sgdisk dependency and do all the other stuff.",
      "parentUuid": "9b029e99_20345cb7",
      "range": {
        "startLine": 267,
        "startChar": 0,
        "endLine": 274,
        "endChar": 3
      },
      "revId": "8f98afd6fdca56f6ec8ce3ec6a5e55aa9a5241b0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    }
  ]
}