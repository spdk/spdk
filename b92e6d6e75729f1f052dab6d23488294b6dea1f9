{
  "comments": [
    {
      "key": {
        "uuid": "6abf9b84_364d91af",
        "filename": "lib/nvmf/rdma.c",
        "patchSetId": 6
      },
      "lineNbr": 2010,
      "author": {
        "id": 1010531
      },
      "writtenOn": "2019-01-22T17:14:36Z",
      "side": 1,
      "message": "spdk_nvmf_rdma_listen is called each time a new listen address is created (i.e. it creates an spdk_nvmf_rmda_port). All of the listen addresses share the same spdk_nvmf_rdma_device (which is an ibv_context). Therefore, device-\u003emap may already exist at this point.\n\nI was asking whether you need a different protection domain per listen address or whether you just need one per rdma device (per ibv context) to try and sort this out. You\u0027ve moved the code to create the memory map/protection domain here instead of having it in the initialization of the transport, so my assumption is that you do indeed need a different protection domain for each listen address. But in that case, you need to move the memory map and the pd to the spdk_nvmf_rdma_port structure instead of keeping it on the device.",
      "revId": "b92e6d6e75729f1f052dab6d23488294b6dea1f9",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fd16e8c4_dba44e0c",
        "filename": "lib/nvmf/rdma.c",
        "patchSetId": 6
      },
      "lineNbr": 2010,
      "author": {
        "id": 1012784
      },
      "writtenOn": "2019-01-23T01:25:00Z",
      "side": 1,
      "message": "Actually the main reason that I have moved the code for setting up device-\u003epd/map from \u0027spdk_nvmf_rdma_create\u0027 to \u0027spdk_nvmf_rdma_listen\u0027 is that I do need port-\u003eid for creating pd, which I can retrieve it in spdk_nvmf_rdma_listen not in spdk_nvmf_rdma_create as port are not set up yet there. \nI can move pd/map from device into port, but then in getting keys in spdk_mem_map_translate for example in call spdk_nvmf_rdma_request_fill_iovs:\nrdma_req-\u003edata.wr.sg_list[i].lkey \u003d ((struct ibv_mr *)spdk_mem_map_translate(device-\u003emap,...\nI have to use pd of one of the ports listed in rtrasport-\u003eports, which it doesn\u0027t seem right to me actually.",
      "parentUuid": "6abf9b84_364d91af",
      "revId": "b92e6d6e75729f1f052dab6d23488294b6dea1f9",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3d313a2c_a6f4b912",
        "filename": "lib/nvmf/rdma.c",
        "patchSetId": 6
      },
      "lineNbr": 2010,
      "author": {
        "id": 1010531
      },
      "writtenOn": "2019-01-24T19:47:45Z",
      "side": 1,
      "message": "If you only need one PD per RDMA device, then why do you need the specific transport ID for each port when requesting the PD? Shouldn\u0027t something more global like the ibv_context be enough?\n\nOn the initiator side we request a PD per controller - is that still correct or do you only need one per RDMA device there as well?",
      "parentUuid": "fd16e8c4_dba44e0c",
      "revId": "b92e6d6e75729f1f052dab6d23488294b6dea1f9",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5e2c0987_62d8fd17",
        "filename": "lib/nvmf/rdma.c",
        "patchSetId": 6
      },
      "lineNbr": 2010,
      "author": {
        "id": 1012784
      },
      "writtenOn": "2019-01-24T20:47:56Z",
      "side": 1,
      "message": "In our frame work, for initializing hookctx, we need trid. Then in requesting rkey, we map pd passed in mem_map_transtale call to its corresponding hookctx, which then we can get keys using mr/sr related data stored in that hookctx. We need to setup different pd and hookctx per controller. Thats the reason that we cannot have global pd.",
      "parentUuid": "3d313a2c_a6f4b912",
      "revId": "b92e6d6e75729f1f052dab6d23488294b6dea1f9",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    }
  ]
}