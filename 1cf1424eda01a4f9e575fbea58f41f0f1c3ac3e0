{
  "comments": [
    {
      "key": {
        "uuid": "2c803e44_9138dc51",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 195,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T07:51:07Z",
      "side": 1,
      "message": "You\u0027re locking twice here, it doesn\u0027t really make sense. Instead of having a function that checks if the blocks are valid under a lock, let\u0027s just operate on bit_array directly while locking only once.",
      "range": {
        "startLine": 186,
        "startChar": 0,
        "endLine": 195,
        "endChar": 35
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7bb3595a_68b0dd2e",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 195,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T08:10:51Z",
      "side": 1,
      "message": "In such case we need recursive lock or spread this lock in more places in code.",
      "parentUuid": "2c803e44_9138dc51",
      "range": {
        "startLine": 186,
        "startChar": 0,
        "endLine": 195,
        "endChar": 35
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2d982225_dbdd7bd0",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 195,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T09:46:31Z",
      "side": 1,
      "message": "No you don\u0027t need recursive lock. You should get rid of the ftl_reloc_lbkoff_valid altogether and just operate on the bit_array directly. In every place this function is used, you\u0027re taking the lock aferwards anyway.",
      "parentUuid": "7bb3595a_68b0dd2e",
      "range": {
        "startLine": 186,
        "startChar": 0,
        "endLine": 195,
        "endChar": 35
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6f879977_3609d733",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 195,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T11:02:44Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "2d982225_dbdd7bd0",
      "range": {
        "startLine": 186,
        "startChar": 0,
        "endLine": 195,
        "endChar": 35
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "998d498e_f7efecd1",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 677,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T07:51:07Z",
      "side": 1,
      "message": "Why is this not under a lock?",
      "range": {
        "startLine": 677,
        "startChar": 0,
        "endLine": 677,
        "endChar": 56
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4ed20ac7_18090aa5",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 677,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T08:10:51Z",
      "side": 1,
      "message": "ftl_reloc_add can only operate on pending_queue from diffrent thread.",
      "parentUuid": "998d498e_f7efecd1",
      "range": {
        "startLine": 677,
        "startChar": 0,
        "endLine": 677,
        "endChar": 56
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "973ecdfd_f4217b17",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 677,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T09:46:31Z",
      "side": 1,
      "message": "It\u0027s a bit hard to follow. Could you please explain in a comment (ideally near the lock definition) the exact structures it\u0027s protecting?",
      "parentUuid": "4ed20ac7_18090aa5",
      "range": {
        "startLine": 677,
        "startChar": 0,
        "endLine": 677,
        "endChar": 56
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bd8f63c2_f02b7cf3",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 677,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T11:02:44Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "973ecdfd_f4217b17",
      "range": {
        "startLine": 677,
        "startChar": 0,
        "endLine": 677,
        "endChar": 56
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1e41f029_601cbb9f",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 727,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T07:51:07Z",
      "side": 1,
      "message": "This will call pthread_spin_destroy on an uninitialized lock.",
      "range": {
        "startLine": 727,
        "startChar": 7,
        "endLine": 727,
        "endChar": 12
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dafe1794_e1f07ec3",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 727,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T11:02:44Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "1e41f029_601cbb9f",
      "range": {
        "startLine": 727,
        "startChar": 7,
        "endLine": 727,
        "endChar": 12
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4648c446_b6a16124",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 785,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T07:51:07Z",
      "side": 1,
      "message": "How are these changes related to the locks?",
      "range": {
        "startLine": 785,
        "startChar": 3,
        "endLine": 785,
        "endChar": 25
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c5de37a1_6feec213",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 785,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T08:15:37Z",
      "side": 1,
      "message": "This need to be done under the lock when we are operate on pending queue, so I\u0027ve moved this from reloc_prep to ftl_reloc_add_active_queue",
      "parentUuid": "4648c446_b6a16124",
      "range": {
        "startLine": 785,
        "startChar": 3,
        "endLine": 785,
        "endChar": 25
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "70f025f3_16241933",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 785,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T09:46:31Z",
      "side": 1,
      "message": "So why are we setting this here without a lock?",
      "parentUuid": "c5de37a1_6feec213",
      "range": {
        "startLine": 785,
        "startChar": 3,
        "endLine": 785,
        "endChar": 25
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1c67a4dc_c3b03b00",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 785,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T11:02:44Z",
      "side": 1,
      "message": "This is for high prio queue which are only set from core thread.",
      "parentUuid": "70f025f3_16241933",
      "range": {
        "startLine": 785,
        "startChar": 3,
        "endLine": 785,
        "endChar": 25
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "13252807_23e973e4",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 809,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T07:51:07Z",
      "side": 1,
      "message": "Shouldn\u0027t all the accesses to the queues be protected by a lock? They\u0027re under a lock in ftl_reloc_add.",
      "range": {
        "startLine": 786,
        "startChar": 0,
        "endLine": 809,
        "endChar": 0
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a5744520_f4ff06da",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 809,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T08:10:51Z",
      "side": 1,
      "message": "There is a lock on pending queue remove in ftl_reloc_add_active_queue().",
      "parentUuid": "13252807_23e973e4",
      "range": {
        "startLine": 786,
        "startChar": 0,
        "endLine": 809,
        "endChar": 0
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "135832fe_9f7cc138",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 809,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T09:46:31Z",
      "side": 1,
      "message": "Yeah, but you\u0027re iterating through the pending/prio queue without a lock.",
      "parentUuid": "a5744520_f4ff06da",
      "range": {
        "startLine": 786,
        "startChar": 0,
        "endLine": 809,
        "endChar": 0
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "af322ea4_9a811229",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 809,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T11:02:44Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "135832fe_9f7cc138",
      "range": {
        "startLine": 786,
        "startChar": 0,
        "endLine": 809,
        "endChar": 0
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "97cebe82_a89e31a8",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 838,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T07:51:07Z",
      "side": 1,
      "message": "Wouldn\u0027t it make more sense to do this atomically? Acquiring the lock twice during each loop iteration doesn\u0027t seem like a good idea...",
      "range": {
        "startLine": 833,
        "startChar": 0,
        "endLine": 838,
        "endChar": 31
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8e24ac25_f4cbe437",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 838,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T08:10:51Z",
      "side": 1,
      "message": "In such case we need recursive lock or spread this lock in more places in code.",
      "parentUuid": "97cebe82_a89e31a8",
      "range": {
        "startLine": 833,
        "startChar": 0,
        "endLine": 838,
        "endChar": 31
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b8ac1a3f_1f522b84",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 838,
      "author": {
        "id": 1015368
      },
      "writtenOn": "2019-06-07T09:46:31Z",
      "side": 1,
      "message": "No, you don\u0027t need recursive lock. You should acquire the lock before the loop and release it at  the end of this function (as you need it again on line 845). Instead of calling the ftl_reloc_lbk_off_valid / ftl_reloc_set_lbk just use the bit_array API.",
      "parentUuid": "8e24ac25_f4cbe437",
      "range": {
        "startLine": 833,
        "startChar": 0,
        "endLine": 838,
        "endChar": 31
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ee76ed82_6cbd89b7",
        "filename": "lib/ftl/ftl_reloc.c",
        "patchSetId": 9
      },
      "lineNbr": 838,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-06-07T11:02:44Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "b8ac1a3f_1f522b84",
      "range": {
        "startLine": 833,
        "startChar": 0,
        "endLine": 838,
        "endChar": 31
      },
      "revId": "1cf1424eda01a4f9e575fbea58f41f0f1c3ac3e0",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    }
  ]
}