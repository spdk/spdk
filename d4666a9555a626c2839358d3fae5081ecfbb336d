{
  "comments": [
    {
      "key": {
        "uuid": "6602a055_47bcecdd",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 93,
      "author": {
        "id": 1011222
      },
      "writtenOn": "2019-01-14T21:22:15Z",
      "side": 1,
      "message": "remove trace_path?",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "b92734a7_25a07174",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 93,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-01-15T12:49:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "6602a055_47bcecdd",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "44d7d3f2_472ee1f5",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 185,
      "author": {
        "id": 1011222
      },
      "writtenOn": "2019-01-14T21:22:15Z",
      "side": 1,
      "message": "can these be uint32_t instead of unsigned int?",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "616413f8_b7f4ba30",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 185,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-01-15T12:49:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "44d7d3f2_472ee1f5",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f342b812_c6854746",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 245,
      "author": {
        "id": 1011222
      },
      "writtenOn": "2019-01-14T21:22:15Z",
      "side": 1,
      "message": "*band doesn\u0027t look aligned with rest of variable declarations",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "cd9c26ae_7f4b6737",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 245,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-01-15T12:49:24Z",
      "side": 1,
      "message": "I think this new gerrit UI has same issue with alignment. When you switch to old UI it looks correct.",
      "parentUuid": "f342b812_c6854746",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dcbb6b57_18d5747c",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 245,
      "author": {
        "id": 1011222
      },
      "writtenOn": "2019-01-17T20:36:10Z",
      "side": 1,
      "message": "You\u0027re right.  I like the new UI in general, but this misalignment thing is driving me crazy.  :)",
      "parentUuid": "cd9c26ae_7f4b6737",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8021ff58_72d75656",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 486,
      "author": {
        "id": 1011222
      },
      "writtenOn": "2019-01-14T21:22:15Z",
      "side": 1,
      "message": "which thread(s) will allocate and free buffers from this pool?  just the core thread?\n\nif so, then you probably want to use something else here instead of an spdk_mempool - you could use a single-producer/single-consumer ring, where you allocate the memory these buffers separately and then insert them into the ring\n\nthe reason is that the spdk mempool isn\u0027t going to end up with any buffers in the per-core cache, meaning every access will require a spin lock \n\nthis is ok for now (functionally it\u0027s fine), but if you don\u0027t fix this now please make a note to fix it in a follow-up patch later",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "92367e74_e2e28f43",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 486,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-01-15T12:49:24Z",
      "side": 1,
      "message": "Only core thread will allocate and freee buffer from this pool. I will add TODO to change this to more efficient data structure.",
      "parentUuid": "8021ff58_72d75656",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ee4fec92_3e18d867",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 566,
      "author": {
        "id": 1011222
      },
      "writtenOn": "2019-01-14T21:22:15Z",
      "side": 1,
      "message": "I think you can get rid of -\u003etid now.  Ben made some recent changes which make spdk_get_thread() cheap using a thread local variable.  So then you can just save the spdk_thread object for the core thread and read thread directly, and use that for the comparison.\n\nWe really need to make that change now, because when we break the 1:1 reactor:thread relationship, using pthread_self() here wouldn\u0027t work.",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f6b9b611_35ef2821",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 566,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-01-15T12:49:24Z",
      "side": 1,
      "message": "Ok, I\u0027ve removed tid from ftl_thread but there is one more modification needed in spdk thread module. Current implementation of spdk_get_thread prints SPDK_ERRLOG(\"No thread allocated\\n\") in case tls_thread \u003d\u003d NULL. In fio_plugin use case IO is generated by separated FIO \"raw pthread\" and if spdk_get_thread() is called on such thread it should return NULL. I think we should remove this ERRLOG. I\u0027ve added this change to thread.c in this patch, is this acceptable?",
      "parentUuid": "ee4fec92_3e18d867",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "336cb400_efddca2d",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 566,
      "author": {
        "id": 1010531
      },
      "writtenOn": "2019-01-17T20:38:54Z",
      "side": 1,
      "message": "You\u0027re hitting a newly introduced bug in the bdev fio_plugin. Here is the fix: https://review.gerrithub.io/c/spdk/spdk/+/441066. That fix makes sure the fio pthreads are always associated with an SPDK thread.",
      "parentUuid": "f6b9b611_35ef2821",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f78871e8_b67dd655",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 566,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-01-18T11:17:51Z",
      "side": 1,
      "message": "Hi Ben,\n\nI\u0027ve looked at your fix and I think we have still same issue:\n\nIn spdk_thread_pool we are setting always tls_thread to NULL on return:\nspdk_thread_poll(struct spdk_thread *thread, uint32_t max_msgs)\n{\n    assert(_get_thread() \u003d\u003d NULL);\n    tls_thread \u003d thread;\n    â€¦.\n    tls_thread \u003d NULL;\n}\n\nSo if we set spdk_set_thread() in spdk_fio_init_thread() we will end up with assert in spdk_thread_poll().\n\nOrginal reason of this issue is that we are calling (in FIO scenario) spdk_get_thread() outside spdk_thread_poll() so it always return NULL. I think that we should make some changes in spdk_thread_pool() to handle this scenario correctly.\n\nFor better view here is  example backtrace from FIO workload:\n#0  spdk_get_thread () at thread.c:440\n#1  0x00007ffff7a73207 in ftl_check_read_thread (dev\u003d0x7fffd800e280) at ftl_core.c:329\n#2  0x00007ffff7a75893 in ftl_io_read (io\u003d0x2000125931c0) at ftl_core.c:1395\n#3  0x00007ffff7a75a20 in spdk_ftl_read (dev\u003d0x7fffd800e280, ch\u003d0x7fffcc0103d0, lba\u003d3425867, lba_cnt\u003d1, \n    iov\u003d0x200003a49dd0, iov_cnt\u003d1, cb_fn\u003d0x7ffff7a7f399 \u003cbdev_ocssd_cb\u003e, cb_arg\u003d0x200003a4a100) at ftl_core.c:1447\n#4  0x00007ffff7a7f534 in bdev_ocssd_readv (bdev\u003d0x7fffd8008c20, ch\u003d0x7fffcc010130, io\u003d0x200003a4a100)\n    at bdev_ocssd.c:293\n#5  0x00007ffff7a7f624 in bdev_ocssd_get_buf_cb (ch\u003d0x7fffcc010130, bdev_io\u003d0x200003a49dc0) at bdev_ocssd.c:327\n#6  0x00007ffff7a8c9a8 in spdk_bdev_io_get_buf (bdev_io\u003d0x200003a49dc0, cb\u003d0x7ffff7a7f5f0 \u003cbdev_ocssd_get_buf_cb\u003e, \n    len\u003d4096) at bdev.c:579\n#7  0x00007ffff7a7f710 in _bdev_ocssd_submit_request (ch\u003d0x7fffcc010130, bdev_io\u003d0x200003a49dc0) at bdev_ocssd.c:355\n#8  0x00007ffff7a7f781 in bdev_ocssd_submit_request (ch\u003d0x7fffcc010130, bdev_io\u003d0x200003a49dc0) at bdev_ocssd.c:377\n#9  0x00007ffff7a8edb4 in _spdk_bdev_io_submit (ctx\u003d0x200003a49dc0) at bdev.c:1588\n#10 0x00007ffff7a8f0e6 in spdk_bdev_io_submit (bdev_io\u003d0x200003a49dc0) at bdev.c:1636\n#11 0x00007ffff7a90cda in spdk_bdev_read_blocks (desc\u003d0x7fffcc010030, ch\u003d0x7fffcc010070, buf\u003d0x200012235000, \n    offset_blocks\u003d3425867, num_blocks\u003d1, cb\u003d0x7ffff7a15482 \u003cspdk_fio_completion_cb\u003e, cb_arg\u003d0x7fffcc00ac70)\n    at bdev.c:2417\n#12 0x00007ffff7a90b95 in spdk_bdev_read (desc\u003d0x7fffcc010030, ch\u003d0x7fffcc010070, buf\u003d0x200012235000,",
      "parentUuid": "336cb400_efddca2d",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4394454e_b514a720",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 566,
      "author": {
        "id": 1010531
      },
      "writtenOn": "2019-01-18T16:22:31Z",
      "side": 1,
      "message": "This patch should fix the spdk_thread_poll behavior: https://review.gerrithub.io/c/spdk/spdk/+/441159",
      "parentUuid": "f78871e8_b67dd655",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ac85bfff_4d913c17",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 820,
      "author": {
        "id": 1011222
      },
      "writtenOn": "2019-01-14T21:22:15Z",
      "side": 1,
      "message": "should have a newline after declarations before the rest of the code starts",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "4e206a00_67cd649a",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 820,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-01-15T12:49:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ac85bfff_4d913c17",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "75a38ce9_f85d1ae0",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 838,
      "author": {
        "id": 1011222
      },
      "writtenOn": "2019-01-14T21:22:15Z",
      "side": 1,
      "message": "if opts-\u003econf is valid, it will overwrite what was done in spdk_ftl_conf_init_defaults - so should we just put this spdk_ftl_conf_init_defaults into an else clause?",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "110b92c2_0af5a0e9",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 838,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-01-15T12:49:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "75a38ce9_f85d1ae0",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f6b29352_c1c0cb3b",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 970,
      "author": {
        "id": 1011222
      },
      "writtenOn": "2019-01-14T21:22:15Z",
      "side": 1,
      "message": "size_t declaration should move to top of function (or even as a separate line within the \"if (dev-\u003ebands)\" block)",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "86a5fd57_1db02428",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 970,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-01-15T12:49:24Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "f6b29352_c1c0cb3b",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f67318d5_6a6be438",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 1042,
      "author": {
        "id": 1011222
      },
      "writtenOn": "2019-01-14T21:22:15Z",
      "side": 1,
      "message": "I noticed that ftl_anm_init() will result in the callback getting executed on the anm thread, not the thread that called ftl_anm_init.  Will that be OK?\n\nThis might be unexpected - elsewhere in SPDK, we always call the callback on the same thread that submitted the callback.",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6b867b36_704c329a",
        "filename": "lib/ftl/ftl_init.c",
        "patchSetId": 46
      },
      "lineNbr": 1042,
      "author": {
        "id": 1015344
      },
      "writtenOn": "2019-01-15T12:49:24Z",
      "side": 1,
      "message": "We need to register ANM poller on separate ANM thread during ftl module initialization and this could potentially fail. We are calling this callback on anm thread to pass result from anm poller registration back to caller. I think this approach is safe in this case.",
      "parentUuid": "f67318d5_6a6be438",
      "revId": "d4666a9555a626c2839358d3fae5081ecfbb336d",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    }
  ]
}