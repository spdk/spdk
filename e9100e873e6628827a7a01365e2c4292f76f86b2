{
  "comments": [
    {
      "key": {
        "uuid": "c5691254_f2999fe2",
        "filename": "module/bdev/nvme/bdev_nvme.c",
        "patchSetId": 25
      },
      "lineNbr": 232,
      "author": {
        "id": 1012251
      },
      "writtenOn": "2019-10-24T07:00:29Z",
      "side": 1,
      "message": "Hi Chunyang, Changpeng,\n\nI understood that this polling is necessary because bdev_nvme_library_fini() requires bdev_nvme_ctrlr_destruct() to complete synchronously.\n\nI have two questions.\n*  How long this polling continues as worst case?\n*  Can we have any way to complete spdk_opal_revert_poll() before coming here, bdev_nvme_ctrlr_destruct()?\n\nIf the second question is no, this may be the only way to do.",
      "revId": "e9100e873e6628827a7a01365e2c4292f76f86b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bd716457_1ef0a25b",
        "filename": "module/bdev/nvme/bdev_nvme.c",
        "patchSetId": 25
      },
      "lineNbr": 232,
      "author": {
        "id": 1012251
      },
      "writtenOn": "2019-10-24T07:07:38Z",
      "side": 1,
      "message": "If this is not avoidable, for example a comment \"we have to wait for completion of reverting here, and it may take 6 or 7 minutes as worst case.\".",
      "parentUuid": "c5691254_f2999fe2",
      "revId": "e9100e873e6628827a7a01365e2c4292f76f86b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "078ffc5b_5a918a20",
        "filename": "module/bdev/nvme/bdev_nvme.c",
        "patchSetId": 25
      },
      "lineNbr": 232,
      "author": {
        "id": 1011792
      },
      "writtenOn": "2019-10-24T07:12:21Z",
      "side": 1,
      "message": "Hi Shuhei, thanks for your review. Let me answer the questions.\n(1) Under worst case, a drive can take 7-8 minutes for revert operation (that is based on our test, maybe some drives can take longer). If we shutdown the target right after the revert is triggered, it will take 7-8 minutes to wait here for the worst case.\n(2) As far as I can see, if bdev_nvme_ctrlr_destruct is called, and the opal_poller hasn\u0027t been unregistered yet, this is the only way.",
      "parentUuid": "c5691254_f2999fe2",
      "revId": "e9100e873e6628827a7a01365e2c4292f76f86b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "eaa1166a_b8a94b0c",
        "filename": "module/bdev/nvme/bdev_nvme.c",
        "patchSetId": 25
      },
      "lineNbr": 232,
      "author": {
        "id": 1012251
      },
      "writtenOn": "2019-10-24T07:25:06Z",
      "side": 1,
      "message": "Thank you Chunyang. Got it. So I hopefully understand what you do now and agree with you about it.\nSome help doc for user will be kind for now, but I don\u0027t have good idea yet.",
      "parentUuid": "078ffc5b_5a918a20",
      "revId": "e9100e873e6628827a7a01365e2c4292f76f86b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "50f566f5_c943aee9",
        "filename": "module/bdev/nvme/bdev_nvme.c",
        "patchSetId": 25
      },
      "lineNbr": 232,
      "author": {
        "id": 1011204
      },
      "writtenOn": "2019-10-24T09:21:31Z",
      "side": 1,
      "message": "For normal cases this should work, but I\u0027m not confident for waiting the revert action here, leaving the revert status as it is maybe better.",
      "parentUuid": "eaa1166a_b8a94b0c",
      "revId": "e9100e873e6628827a7a01365e2c4292f76f86b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "65bddd1b_b464a561",
        "filename": "module/bdev/nvme/bdev_nvme.c",
        "patchSetId": 25
      },
      "lineNbr": 232,
      "author": {
        "id": 1012251
      },
      "writtenOn": "2019-10-24T10:34:19Z",
      "side": 1,
      "message": "Hi Chunyang, Changpeng,\n\nChunyang said opal_dev is not bdev, so can we wait its revert completion before exiting opal bdev module? Then we can avoid this busy loop?",
      "parentUuid": "50f566f5_c943aee9",
      "revId": "e9100e873e6628827a7a01365e2c4292f76f86b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "42d1cc7f_e9bb97da",
        "filename": "module/bdev/nvme/bdev_nvme.c",
        "patchSetId": 25
      },
      "lineNbr": 232,
      "author": {
        "id": 1012251
      },
      "writtenOn": "2019-10-24T11:15:27Z",
      "side": 1,
      "message": "Or I think we can make module_fini asynchronous and remove this busy loop as an next enhancement",
      "parentUuid": "65bddd1b_b464a561",
      "revId": "e9100e873e6628827a7a01365e2c4292f76f86b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    }
  ]
}