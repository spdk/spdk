{
  "comments": [
    {
      "key": {
        "uuid": "31c87e50_73cdab34",
        "filename": "lib/vhost/vhost_scsi.c",
        "patchSetId": 3
      },
      "lineNbr": 947,
      "author": {
        "id": 1011218
      },
      "writtenOn": "2019-03-06T22:57:53Z",
      "side": 1,
      "message": "This looks wrong. You don\u0027t set this SCSI device until line #958.",
      "range": {
        "startLine": 947,
        "startChar": 41,
        "endLine": 947,
        "endChar": 84
      },
      "revId": "2a0bc96c2613cf7542f7bb663803de7a418ab47e",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "cc30ed32_94b76dc6",
        "filename": "lib/vhost/vhost_scsi.c",
        "patchSetId": 3
      },
      "lineNbr": 947,
      "author": {
        "id": 1011230
      },
      "writtenOn": "2019-03-07T07:49:21Z",
      "side": 1,
      "message": "It\u0027s just useless to set it here just to unset it in case of failure.",
      "parentUuid": "31c87e50_73cdab34",
      "range": {
        "startLine": 947,
        "startChar": 41,
        "endLine": 947,
        "endChar": 84
      },
      "revId": "2a0bc96c2613cf7542f7bb663803de7a418ab47e",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "157454da_9ccfc733",
        "filename": "lib/vhost/vhost_scsi.c",
        "patchSetId": 3
      },
      "lineNbr": 951,
      "author": {
        "id": 1011218
      },
      "writtenOn": "2019-03-06T22:57:53Z",
      "side": 1,
      "message": "So if the status used to be VHOST_SCSI_DEV_REMOVED, we will continue sending hotremove sense codes for that SCSI target. This looks wrong if there\u0027s more than one session and channel allocation only fails for some of them - It could be that one session will fail I/O with SCSI hotremove sense codes and other session will process I/O just fine.",
      "revId": "2a0bc96c2613cf7542f7bb663803de7a418ab47e",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c43eb508_5d29ef9c",
        "filename": "lib/vhost/vhost_scsi.c",
        "patchSetId": 3
      },
      "lineNbr": 951,
      "author": {
        "id": 1011230
      },
      "writtenOn": "2019-03-07T07:49:21Z",
      "side": 1,
      "message": "Unless I\u0027m blind, it will work just as you described. The *session* device state stay unchanged. Do you see different path here?",
      "parentUuid": "157454da_9ccfc733",
      "revId": "2a0bc96c2613cf7542f7bb663803de7a418ab47e",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3955fc4c_a7b6e280",
        "filename": "lib/vhost/vhost_scsi.c",
        "patchSetId": 3
      },
      "lineNbr": 951,
      "author": {
        "id": 1011218
      },
      "writtenOn": "2019-03-13T14:28:18Z",
      "side": 1,
      "message": "if a previous device at that scsi_tgt_num has been hotremoved, the status will remain at VHOST_SCSI_DEV_REMOVED and we will continue sending hotremove events, which is wrong. From the vhost master\u0027s point of view, the device was never attached, so it shouldn\u0027t be reported as hotremoved.\n\nWe previously set session_sdev-\u003estatus here to VHOST_SCSI_DEV_EMPTY just for that case.",
      "parentUuid": "c43eb508_5d29ef9c",
      "revId": "2a0bc96c2613cf7542f7bb663803de7a418ab47e",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6ec94e75_52fb862f",
        "filename": "lib/vhost/vhost_scsi.c",
        "patchSetId": 3
      },
      "lineNbr": 951,
      "author": {
        "id": 1011230
      },
      "writtenOn": "2019-03-14T09:54:43Z",
      "side": 1,
      "message": "\u003e From the vhost master\u0027s point of view\n\nFrom vdev point of view yes and this done by setting \n\n  svsession-\u003escsi_dev_state[scsi_tgt_num].status \u003d EMPTY\n\nwhen all sessions removed their targets (see remove_scsi_tgt()). This way new sessions will see EMPTY state and old sessions will keep REMOVED, as it was seen but removed in this session. Until new device is added successfully old code should be preserved.\n\nSo when you try to add target, then remove it then try to add it again but fail here is the flow:\n\n 1. Device added -\u003e session_sdev-\u003estatus \u003d PRESENT\n 2. Device removed -\u003e session_sdev-\u003estatus \u003d REMOVED\n   - initator scan - SENSE code removed.\n   - initator scan - SENSE code removed.\n   - initator scan - SENSE code removed.\n 3. Try to add device -\u003e failed -\u003e session_sdev-\u003estatus unchanged\n   - initator scan - SENSE code removed.\n 4. Try to add device -\u003e OK -\u003e session_sdev-\u003estatus \u003d PRESENT\n   - initator scan - OK",
      "parentUuid": "3955fc4c_a7b6e280",
      "revId": "2a0bc96c2613cf7542f7bb663803de7a418ab47e",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9695fe42_5132f700",
        "filename": "lib/vhost/vhost_scsi.c",
        "patchSetId": 3
      },
      "lineNbr": 951,
      "author": {
        "id": 1011230
      },
      "writtenOn": "2019-03-14T09:54:43Z",
      "side": 1,
      "message": "\u003e From the vhost master\u0027s point of view\n\nFrom vdev point of view yes and this done by setting \n\n  svsession-\u003escsi_dev_state[scsi_tgt_num].status \u003d EMPTY\n\nwhen all sessions removed their targets. This way new sessions will see EMPTY state and old sessions will save REMOVED (as it was see but removed in that session).\n\n 1. Device added -\u003e session_sdev-\u003estatus \u003d PRESENT\n 2. Device removed -\u003e session_sdev-\u003estatus \u003d REMOVED\n   - initator scan - SENSE code removed.\n   - initator scan - SENSE code removed.\n   - initator scan - SENSE code removed.\n 3. Try to add device -\u003e failed -\u003e session_sdev-\u003estatus unchanged\n   - initator scan - SENSE code removed.\n 4. Try to add device -\u003e OK -\u003e session_sdev-\u003estatus \u003d PRESENT\n   - initator scan - OK",
      "parentUuid": "3955fc4c_a7b6e280",
      "revId": "2a0bc96c2613cf7542f7bb663803de7a418ab47e",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    }
  ]
}