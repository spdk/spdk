{
  "comments": [
    {
      "key": {
        "uuid": "65116a20_0c86103b",
        "filename": "lib/nvmf/ctrlr.c",
        "patchSetId": 6
      },
      "lineNbr": 319,
      "author": {
        "id": 1010525
      },
      "writtenOn": "2018-04-23T20:57:17Z",
      "side": 1,
      "message": "I\u0027m not sure we need to send a message here. This branch is only reachable when qpair is the admin queue, so we should already be on qpair-\u003egroup-\u003ethread at this point.  The only call to this function is via spdk_nvmf_ctrlr_disconnect(), which sends a message to admin_qpair-\u003egroup-\u003ethread.",
      "revId": "43d5fb8641b7e986cda636c47a13c0fbf88c92ad",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "cff67d6e_d577f1fe",
        "filename": "lib/nvmf/ctrlr.c",
        "patchSetId": 6
      },
      "lineNbr": 319,
      "author": {
        "id": 1010531
      },
      "writtenOn": "2018-04-23T21:11:47Z",
      "side": 1,
      "message": "Yeah - this is running on the right thread already. I think you should just make this do:\n\nTAILQ_REMOEV(...)\nspdk_thread_send_msg(thread, nvmf_qpair_fini, qpair);\n\nNo need to recursively call ctrlr_delete_qpair because it\u0027s only two lines of code.",
      "parentUuid": "65116a20_0c86103b",
      "revId": "43d5fb8641b7e986cda636c47a13c0fbf88c92ad",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "579f2744_baeb6a4e",
        "filename": "lib/nvmf/ctrlr.c",
        "patchSetId": 6
      },
      "lineNbr": 319,
      "author": {
        "id": 1011275
      },
      "writtenOn": "2018-04-24T01:57:42Z",
      "side": 1,
      "message": "Hi Ben/Daniel,\n\nFirst time, I have the same idea as you. However, you can see that each io qpair will have their own thread to destruct, so we can not directly delete the admin qpair here. If my understanding is correct, the admin qpair should make sure that all I/O qpairs are deleted, then we can delete the admin qpair in this case. \n\nIf you directly do the remove and call the nvmf_qpair_fini, the admin qpair will be deleted earlier than other I/O qpair from logic since you cannot guarantee the order, which sounds not a correct behavior from my understanding.\n\nAnd from the initiator side, it may see the admin qpair is destroyed earlier than I/O qpair.",
      "parentUuid": "cff67d6e_d577f1fe",
      "revId": "43d5fb8641b7e986cda636c47a13c0fbf88c92ad",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "27746558_b11de44e",
        "filename": "lib/nvmf/ctrlr.c",
        "patchSetId": 6
      },
      "lineNbr": 319,
      "author": {
        "id": 1011275
      },
      "writtenOn": "2018-04-24T02:19:34Z",
      "side": 1,
      "message": "Also if you do that, nvmf_qpair_fini (executed by the I/O qpair thread will not find the admin qpair, and will cause the error.",
      "parentUuid": "579f2744_baeb6a4e",
      "revId": "43d5fb8641b7e986cda636c47a13c0fbf88c92ad",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "978df166_d6b0049e",
        "filename": "lib/nvmf/ctrlr.c",
        "patchSetId": 6
      },
      "lineNbr": 319,
      "author": {
        "id": 1010531
      },
      "writtenOn": "2018-04-24T16:30:57Z",
      "side": 1,
      "message": "Modifying the ctrlr data structure must be done only on the core that owns the admin qpair, so you can\u0027t send a message to an arbitrary qpair\u0027s thread and call ctrlr_delete_qpair on line 319.\n\nThe way this really needs to work is in spdk_nvmf_ctrlr_disconnect, it needs to check if the qpair disconnecting is the admin qpair. If it is, it should do an spdk_for_each_channel on the spdk_nvmf_tgt structure to send a message to each poll group. On each poll group, destroy every qpair associated with the given controller. When the for_each completes, destroy the admin qpair and then the whole controller.",
      "parentUuid": "27746558_b11de44e",
      "revId": "43d5fb8641b7e986cda636c47a13c0fbf88c92ad",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1753309b_0df41751",
        "filename": "lib/nvmf/ctrlr.c",
        "patchSetId": 6
      },
      "lineNbr": 319,
      "author": {
        "id": 1011275
      },
      "writtenOn": "2018-04-24T21:33:39Z",
      "side": 1,
      "message": "in line319ï¼Œ the qpair is the admin thread, and I sent to the poller group already. And current implementation is the same meaning described by you",
      "parentUuid": "978df166_d6b0049e",
      "revId": "43d5fb8641b7e986cda636c47a13c0fbf88c92ad",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0cef2fff_6767d886",
        "filename": "lib/nvmf/ctrlr.c",
        "patchSetId": 6
      },
      "lineNbr": 319,
      "author": {
        "id": 1010531
      },
      "writtenOn": "2018-04-26T16:51:13Z",
      "side": 1,
      "message": "oh I missed the _qpair vs qpair. Ok, I see what this is doing.",
      "parentUuid": "1753309b_0df41751",
      "revId": "43d5fb8641b7e986cda636c47a13c0fbf88c92ad",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": false
    }
  ]
}